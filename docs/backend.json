
{
  "entities": {
    "Topic": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Topic",
      "type": "object",
      "description": "Represents a topic or category for organizing notes.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the topic."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Topic)"
        },
        "name": {
          "type": "string",
          "description": "The title of the topic."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the topic was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the topic was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "name",
        "createdAt"
      ]
    },
    "Note": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Note",
      "type": "object",
      "description": "Represents a single note or code snippet within a topic. Can be nested under a parent note.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the note."
        },
        "topicId": {
          "type": "string",
          "description": "Reference to Topic. (Relationship: Topic 1:N Note)"
        },
        "parentId": {
          "type": [
            "string",
            "null"
          ],
          "description": "Optional reference to another Note, creating a parent-child relationship. (Relationship: Note 1:N Note)"
        },
        "title": {
          "type": "string",
          "description": "The title of the note."
        },
        "content": {
          "type": "string",
          "description": "The content of the note, which could be code or text."
        },
        "type": {
          "type": "string",
          "enum": [
            "code",
            "text"
          ]
        },
        "highlightedContent": {
          "type": "string",
          "description": "The HTML representation of the code with syntax highlighting."
        },
        "language": {
          "type": "string",
          "description": "The programming language of the code snippet."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the note was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the note was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "topicId",
        "title",
        "content",
        "type",
        "createdAt",
        "updatedAt"
      ]
    },
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user (Firebase UID)."
        },
        "email": {
          "type": "string",
          "description": "The user's email address.",
          "format": "email"
        },
        "displayName": {
          "type": "string",
          "description": "The user's display name."
        },
        "photoURL": {
          "type": "string",
          "description": "URL of the user's profile photo.",
          "format": "uri"
        }
      },
      "required": [
        "id",
        "email"
      ]
    },
    "StudyStats": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "StudyStats",
      "type": "object",
      "description": "Stores aggregated study statistics for a single user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "The user's UID, acting as the document ID."
        },
        "totalMinutesStudied": {
          "type": "number",
          "description": "Total minutes spent in focus sessions."
        },
        "dailyMinutes": {
          "type": "object",
          "description": "Map of study minutes per day. Key: YYYY-MM-DD, Value: minutes.",
          "additionalProperties": {
            "type": "number"
          }
        },
        "streak": {
          "type": "number",
          "description": "Current daily study streak."
        },
        "bestStreak": {
            "type": "number",
            "description": "All-time best daily study streak."
        },
        "lastStudyDate": {
          "type": "string",
          "description": "The last date (YYYY-MM-DD) the user studied.",
          "format": "date"
        },
        "totalNotesEdited": {
          "type": "number",
          "description": "Total number of notes edited by the user."
        },
        "totalLinesTyped": {
          "type": "number",
          "description": "Total number of lines/characters typed in code notes."
        },
        "topicMinutes": {
          "type": "object",
          "description": "Map of study minutes per topic. Key: topicId, Value: minutes.",
          "additionalProperties": {
            "type": "number"
          }
        },
        "practiceSessions": {
          "type": "object",
          "description": "Map of practice session stats per note. Key: noteId.",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "count": { "type": "number" },
              "averageScore": { "type": "number" }
            },
            "required": ["count", "averageScore"]
          }
        },
        "totalPracticeSessions": {
          "type": "number",
          "description": "Total number of practice sessions completed."
        }
      },
      "required": [
        "id"
      ]
    },
    "FocusSession": {
        "$schema": "http://json-schema.org/draft-07/schema#",
        "title": "FocusSession",
        "type": "object",
        "description": "A temporary document to sync Pomodoro timer state between devices.",
        "properties": {
            "id": {
                "type": "string",
                "description": "Unique identifier for the session."
            },
            "userId": {
                "type": "string",
                "description": "The UID of the user who started the session."
            },
            "mode": {
                "type": "string",
                "enum": ["focus", "break", "longBreak"]
            },
            "timeLeft": {
                "type": "number",
                "description": "Seconds remaining in the current timer."
            },
            "isActive": {
                "type": "boolean",
                "description": "Whether the timer is currently running."
            },
            "expiresAt": {
                "type": "string",
                "format": "date-time",
                "description": "Timestamp when this session document can be safely deleted."
            }
        },
        "required": [
            "id",
            "userId",
            "mode",
            "timeLeft",
            "isActive",
            "expiresAt"
        ]
    },
    "Todo": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Todo",
      "type": "object",
      "description": "Represents a single to-do item for a user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the to-do item."
        },
        "userId": {
          "type": "string",
          "description": "The UID of the user who owns this task."
        },
        "content": {
          "type": "string",
          "description": "The text content of the to-do item."
        },
        "isCompleted": {
          "type": "boolean",
          "description": "Whether the task has been completed."
        },
        "dueDate": {
          "type": "string",
          "format": "date",
          "description": "Optional due date for the task in YYYY-MM-DD format."
        },
        "createdAt": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp when the task was created."
        },
        "completedAt": {
          "type": ["string", "null"],
          "format": "date-time",
          "description": "Timestamp when the task was marked as complete."
        }
      },
      "required": ["id", "userId", "content", "isCompleted", "createdAt"]
    },
     "RecursionBoard": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "RecursionBoard",
      "type": "object",
      "description": "Represents a single board for visualizing recursion.",
      "properties": {
        "id": { "type": "string" },
        "userId": { "type": "string" },
        "name": { "type": "string" },
        "createdAt": { "type": "string", "format": "date-time" },
        "updatedAt": { "type": "string", "format": "date-time" }
      },
      "required": ["id", "userId", "name", "createdAt", "updatedAt"]
    },
    "RecursionCard": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "RecursionCard",
      "type": "object",
      "description": "A single card on a recursion board.",
      "properties": {
        "id": { "type": "string" },
        "boardId": { "type": "string" },
        "title": { "type": "string" },
        "subtitle": { "type": "string" },
        "type": { "type": "string", "enum": ["base", "recursive", "helper"] },
        "x": { "type": "number" },
        "y": { "type": "number" },
        "width": { "type": "number" },
        "notes": { "type": "string" }
      },
      "required": ["id", "boardId", "title", "type", "x", "y"]
    },
    "RecursionConnection": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "RecursionConnection",
      "type": "object",
      "description": "A connection between two cards on a recursion board.",
      "properties": {
        "id": { "type": "string" },
        "boardId": { "type": "string" },
        "fromCardId": { "type": "string" },
        "toCardId": { "type": "string" },
        "label": { "type": "string" }
      },
      "required": ["id", "boardId", "fromCardId", "toCardId"]
    }
  },
  "auth": {
    "providers": [
      "google.com",
      "password"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Collection to store user profiles. Each document represents a user identified by their Firebase UID.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase UID of the user."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/topics/{topicId}",
        "definition": {
          "entityName": "Topic",
          "schema": {
            "$ref": "#/backend/entities/Topic"
          },
          "description": "Subcollection to store topics created by a user. Includes denormalized 'userId' for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase UID of the user who owns the topic."
            },
            {
              "name": "topicId",
              "description": "The unique ID of the topic."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/topics/{topicId}/notes/{noteId}",
        "definition": {
          "entityName": "Note",
          "schema": {
            "$ref": "#/backend/entities/Note"
          },
          "description": "Subcollection to store notes within a topic. Notes can be nested using the `parentId` field. Includes denormalized 'userId' for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase UID of the user who owns the note."
            },
            {
              "name": "topicId",
              "description": "The unique ID of the topic to which the note belongs."
            },
            {
              "name": "noteId",
              "description": "The unique ID of the note."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/todos/{todoId}",
        "definition": {
          "entityName": "Todo",
          "schema": {
            "$ref": "#/backend/entities/Todo"
          },
          "description": "Subcollection to store to-do items for a user.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase UID of the user who owns the to-do."
            },
            {
              "name": "todoId",
              "description": "The unique ID for the to-do item."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/studyStats/{userId}",
        "definition": {
            "entityName": "StudyStats",
            "schema": {
                "$ref": "#/backend/entities/StudyStats"
            },
            "description": "A singleton document containing all study statistics for a user, identified by their UID.",
            "params": [
                {
                    "name": "userId",
                    "description": "The Firebase UID of the user whose stats are being stored."
                }
            ]
        }
      },
       {
        "path": "/focusSessions/{sessionId}",
        "definition": {
          "entityName": "FocusSession",
          "schema": {
            "$ref": "#/backend/entities/FocusSession"
          },
          "description": "Top-level collection for temporary focus sessions to sync timers. Publicly readable but writable only by the owner.",
          "params": [
            {
              "name": "sessionId",
              "description": "Unique ID for the focus session."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/recursionBoards/{boardId}",
        "definition": {
          "entityName": "RecursionBoard",
          "schema": { "$ref": "#/backend/entities/RecursionBoard" },
          "description": "Subcollection for user's recursion boards."
        }
      },
      {
        "path": "/users/{userId}/recursionBoards/{boardId}/cards/{cardId}",
        "definition": {
          "entityName": "RecursionCard",
          "schema": { "$ref": "#/backend/entities/RecursionCard" },
          "description": "Subcollection for cards within a recursion board."
        }
      },
      {
        "path": "/users/{userId}/recursionBoards/{boardId}/connections/{connectionId}",
        "definition": {
          "entityName": "RecursionConnection",
          "schema": { "$ref": "#/backend/entities/RecursionConnection" },
          "description": "Subcollection for connections between cards on a board."
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to provide a secure, scalable, and debuggable solution for the CodeNote application, adhering to the core design principles and strategy mandates. The primary goal is to ensure that each user can only access their own data, avoiding any possibility of cross-user data leakage.\n\n**Authorization Independence (CRITICAL):** The structure enforces Authorization Independence by embedding the `userId` within both the `topics` and `notes` documents. This eliminates the need for `get()` calls in security rules to verify ownership based on parent document data, simplifying rules and ensuring atomic operations.\n\n**Structural Segregation (Homogeneous Security Posture):** The design segregates user-specific data under the `/users/{userId}` path. This approach ensures that all documents within a given user's subcollections (`topics` and `notes`) share the same security requirements, thereby avoiding the complexity of mixed-access data within a single collection.\n\n**Access Modeling:** The structure leverages path-based ownership to control access. The `/users/{userId}/topics/{topicId}/notes/{noteId}` hierarchy clearly defines the ownership relationship: a user owns topics, and topics own notes. This model simplifies security rules based on the current user's `uid`.\n\n**QAPs (Rules are not Filters):** The chosen structure ensures secure `list` operations by restricting access to only the topics and notes belonging to the authenticated user. Since each user's data is stored under their unique `userId`, listing operations are inherently scoped to that user's data, preventing cross-user data access.\n\n**Data Clarity and Predictability:** The schema for `Topic` and `Note` includes explicit timestamps (`createdAt`, `updatedAt`) and a clear ownership structure, enhancing data clarity and predictability. The use of standard naming conventions (`userId`, `topicId`, `noteId`) further improves debuggability and maintainability. The addition of an optional `parentId` field on the `Note` entity allows for hierarchical organization of notes within a topic. The new `StudyStats` entity is stored in a subcollection under the user, with the document ID matching the user's UID to enforce a one-to-one relationship and simplify security rules. The new `RecursionBoard` entities are structured similarly under the user, with boards, cards, and connections in nested subcollections to maintain data locality and simplify ownership rules."
  }
}
