import jsPDF from 'jspdf';
import html2canvas from 'html2canvas';
import { Note } from './types';
import { format } from 'date-fns';

interface NoteForPdf extends Note {
  topicName: string;
}

const PAGE_MARGIN = 40;
const CONTENT_WIDTH = 595.28 - (PAGE_MARGIN * 2);
const PAGE_HEIGHT = 841.89;

let yPos = 0; // GLOBAL y cursor

// --------------------- HEADER ------------------------
const addHeader = (doc: jsPDF, topicName: string) => {
  const pageNumber = doc.getNumberOfPages();
  doc.setPage(pageNumber);
  doc.setFontSize(9);
  doc.setTextColor('#666');
  doc.text(topicName, PAGE_MARGIN, 25);
  doc.text(`Page ${pageNumber}`, 595.28 - PAGE_MARGIN, 25, { align: 'right' });
  doc.setDrawColor('#ddd');
  doc.line(PAGE_MARGIN, 30, 595.28 - PAGE_MARGIN, 30);
};

// --------------------- FOOTER ------------------------
const addFooter = (doc: jsPDF) => {
  const pageNumber = doc.getNumberOfPages();
  for (let i = 1; i <= pageNumber; i++) {
    doc.setPage(i);
    doc.setFontSize(8);
    doc.setTextColor('#aaa');
    doc.text('Generated by CodeNote', 595.28 / 2, PAGE_HEIGHT - 15, { align: 'center' });
  }
};

// ----------------- HTML CANVAS CONTAINER -------------
const createStyledContainer = () => {
  const container = document.createElement('div');
  container.classList.add("pdf-render-container");
  document.body.appendChild(container);

  const style = document.createElement("style");
  style.innerHTML = `
    .pdf-render-container {
      position: absolute;
      left: -9999px;
      top: 0;
      width: ${CONTENT_WIDTH}px;
      padding: 0;
      margin: 0;
      background: white;
      font-family: 'Helvetica', 'Arial', sans-serif;
      color: black;
      -webkit-print-color-adjust: exact;
    }
    .pdf-note-container {
      font-size: 10pt;
      line-height: 1.4;
      width: 100%;
    }
    .pdf-note-container p { margin: 0 0 8px 0; }
    .pdf-note-container h1 { font-size: 16pt; margin: 0 0 10px 0; }
    .pdf-note-container h2 { font-size: 14pt; margin: 0 0 8px 0; }
    .pdf-note-container h3 { font-size: 12pt; margin: 0 0 6px 0; }
    .pdf-note-container pre {
      background: #f3f4f6;
      padding: 8px;
      border-radius: 5px;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .pdf-note-container code {
      font-family: "Source Code Pro", "Courier New", monospace;
      font-size: 9pt;
      line-height: 1.2;
    }
  `;
  document.body.appendChild(style);

  return container;
};

// ----------------- MAIN EXPORT FUNCTION ---------------
export const generatePdf = async (notes: NoteForPdf[]) => {
  const doc = new jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });
  const container = createStyledContainer();

  doc.deletePage(1);

  const sortedNotes = [...notes].sort((a, b) => {
    if (a.topicName < b.topicName) return -1;
    if (a.topicName > b.topicName) return 1;
    const dateA = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : 0;
    const dateB = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : 0;
    return dateA - dateB;
  });
  
  yPos = 0; // Reset global y cursor
  let currentTopicName = "";

  sortedNotes.forEach((note, i) => {
    const isNewTopic = note.topicName !== currentTopicName;
    currentTopicName = note.topicName;
    
    // Add a new page if it's the first note, a new topic, or not enough space
    if (i === 0 || isNewTopic) {
      doc.addPage();
      yPos = PAGE_MARGIN + 20;
      addHeader(doc, currentTopicName);
    }

    // Check space before rendering note header
    if (yPos + 80 > PAGE_HEIGHT - PAGE_MARGIN) {
      doc.addPage();
      yPos = PAGE_MARGIN + 20;
      addHeader(doc, currentTopicName);
    }
    
    // -------- Note Title + Metadata ----------
    const created = note.createdAt?.toDate ? format(note.createdAt.toDate(), 'PPP') : 'N/A';
    const updated = note.updatedAt?.toDate ? format(note.updatedAt.toDate(), 'PPP') : 'N/A';
    
    doc.setFont("Helvetica", "bold");
    doc.setFontSize(13);
    doc.text(note.title, PAGE_MARGIN, yPos);
    yPos += 18;

    doc.setFont("Helvetica", "normal");
    doc.setFontSize(8);
    doc.setTextColor("#444");
    doc.text(`Created: ${created}     Updated: ${updated}`, PAGE_MARGIN, yPos);
    yPos += 20;

    doc.setDrawColor("#ddd");
    doc.line(PAGE_MARGIN, yPos - 12, CONTENT_WIDTH + PAGE_MARGIN, yPos - 12);

    // ========== CODE NOTE (Plain Text) ==========
    if (note.type === "code") {
      doc.setFont("Courier", "normal");
      doc.setFontSize(8);
      doc.setTextColor("#000");

      const codeLines = doc.splitTextToSize(note.content || '', CONTENT_WIDTH - 10);
      const codeBlockHeight = codeLines.length * 8 * 1.2;
      
      // Check space for the code block
      if (yPos + codeBlockHeight + 20 > PAGE_HEIGHT - PAGE_MARGIN) {
        doc.addPage();
        yPos = PAGE_MARGIN + 20;
        addHeader(doc, currentTopicName);
      }
      
      doc.setFillColor("#f3f4f6");
      doc.rect(PAGE_MARGIN, yPos, CONTENT_WIDTH, codeBlockHeight + 10, "F");

      doc.text(codeLines, PAGE_MARGIN + 5, yPos + 10, { lineHeightFactor: 1.2 });
      yPos += codeBlockHeight + 30; // Spacing after note

    } else {
      // ============ RICH TEXT NOTE (CANVAS) ============
      const elem = document.createElement("div");
      elem.className = "pdf-note-container";
      elem.innerHTML = note.highlightedContent || note.content;
      container.innerHTML = "";
      container.appendChild(elem);

      html2canvas(container, { scale: 2, width: CONTENT_WIDTH, windowWidth: CONTENT_WIDTH })
        .then(canvas => {
          const imgData = canvas.toDataURL("image/png");
          const imgProps = doc.getImageProperties(imgData);
          const pdfImgWidth = CONTENT_WIDTH;
          const pdfImgHeight = (imgProps.height * pdfImgWidth) / imgProps.width;

          let remainingHeight = pdfImgHeight;
          let imgOffsetY = 0;

          while (remainingHeight > 0) {
            const spaceOnPage = PAGE_HEIGHT - PAGE_MARGIN - yPos;
            const heightToDraw = Math.min(spaceOnPage, remainingHeight);

            if (heightToDraw <= 0) {
                doc.addPage();
                yPos = PAGE_MARGIN + 20;
                addHeader(doc, currentTopicName);
                continue;
            }

            doc.addImage(
              imgData,
              "PNG",
              PAGE_MARGIN,
              yPos,
              pdfImgWidth,
              pdfImgHeight,
              undefined,
              "FAST",
              0,
              imgOffsetY
            );

            remainingHeight -= heightToDraw;
            imgOffsetY += heightToDraw;

            if (remainingHeight > 0) {
              doc.addPage();
              yPos = PAGE_MARGIN + 20;
              addHeader(doc, currentTopicName);
            } else {
              yPos += heightToDraw + 20; // Spacing after note
            }
          }
        });
    }
  });

  addFooter(doc);

  const filename = notes.length === 1
    ? notes[0].title.replace(/[^a-z0-9]/gi, "_").toLowerCase()
    : "codenote-export";

  document.body.removeChild(container.previousSibling as Node);
  document.body.removeChild(container);
  
  doc.save(filename + ".pdf");
};
